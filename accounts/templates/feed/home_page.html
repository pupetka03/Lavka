<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FX</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/main.css' %}" />
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    {% load number_filters %} 
    {% include "nav_bar.html" %}

    <div class="main-content">
        <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Ñ—ñ–¥—ñ–≤ -->
        <div class="feed-switcher">
            <div class="feed-tab active" data-feed="feed1">Hlavna stranka</div>
            {% if request.user.is_authenticated %}
            <div class="feed-tab" data-feed="feed2">Nove pr√≠spevky</div>
            {% endif %}
        </div>

        <!-- –ü–µ—Ä—à–∏–π —Ñ—ñ–¥ -->
        <div id="feed1" class="feed-content active">
            {% for pub in publication %}
            <div class="publication-wrapper" id="pub-{{ pub.slug }}">
                <div>
                    <div class="post-author">
                        <a href="{% url 'profile' pub.user.username %}" class="user-avatar">
                            {{ pub.user.username|first|upper }}
                        </a>
                        {{ pub.title }}
                        <span class="post-handle">@{{ pub.user.username }}</span>
                    </div>

                    <div class="post-text">
                        <a href="{% url 'pub' pub.slug %}" style="text-decoration:none; color:inherit; cursor:pointer;">
                            {{ pub.text }}
                        </a>
                    </div>
                    
                    <div class="post-tags">
                        {% for tag in pub.tags.all %}
                        <span class="tag">#{{ tag }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="post-stats">
                        {% if request.user.is_authenticated %}
                            <!-- –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å, –∞ –Ω–µ id, –±–æ –±—É–¥–µ –±–∞–≥–∞—Ç–æ —Ç–∞–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ -->
                            <button type="button" class="comments-toggle-btn" data-slug="{{ pub.slug }}">
                                üí¨ {{ pub.comments.count }}
                            </button>
                        {% else %}
                            <span style="color:inherit; cursor:default;">
                                üí¨ {{ pub.comments.count }}
                            </span>
                        {% endif %}
                        
                        <span class="like-button" data-slug="{{ pub.slug }}" style="cursor:pointer;">
                            ‚ù§Ô∏è <span class="like-count">{{ pub.likes.count }}</span>
                        </span>
                    </div>
                </div>

                <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ –¥–ª—è —Ü—ñ—î—ó –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó -->
                {% for comment in pub.comments.all|slice:":3" %} 
                    {% if not comment.parent %}
                    <div class="comment-section-wrapper">
                        <div class="comment-item">
                            <div class="comment-author">
                                <a href="{% url 'profile' comment.user.username %}" class="user-avatar comment-avatar">
                                    {{ comment.user.username|first|upper }}
                                </a>
                                {{ comment.user }}
                                <span class="post-handle">@{{ comment.user }}</span>
                            </div>
                            <div class="comment-text">{{ comment.text }}</div>
                        </div>
                    </div>
                    {% endif %} 
                {% endfor %}
            </div>
            {% empty %}
            <div style="padding: 20px; text-align: center; color: #5b7083;">
                Zatiaƒæ ≈æiadny obsah
            </div>
            {% endfor %}
            
            <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
            <div class="pagination">
                {% if page_feed > 0 %}
                <form method="get" style="flex: 1;">
                    <input type="hidden" name="page_feed" value="{{ page_feed|add:'-1' }}" />
                    <input type="hidden" name="active_feed" value="feed1" />
                    <button type="submit" class="post-button" style="width: 100%; margin-top: 0;">
                        dozadu
                    </button>
                </form>
                {% endif %}

                <form method="get" style="flex: 1;">
                    <input type="hidden" name="page_feed" value="{{ page_feed|add:'1' }}" />
                    <input type="hidden" name="active_feed" value="feed1" />
                    <button type="submit" class="post-button" style="width: 100%; margin-top: 0;">
                        dopredu
                    </button>
                </form>
            </div>
        </div>

        <!-- –î—Ä—É–≥–∏–π —Ñ—ñ–¥ -->
        <div id="feed2" class="feed-content">
            {% for pub in explore_publications %}
            <div class="publication-wrapper">
                <div>
                    <div class="post-author">
                        <a href="{% url 'profile' pub.user.username %}" class="user-avatar">
                            {{ pub.user.username|first|upper }}
                        </a>
                        {{ pub.title }}
                        <span class="post-handle">@{{ pub.user.username }}</span>
                    </div>
                    
                    <div class="post-text">
                        <a href="{% url 'pub' pub.slug %}" style="text-decoration:none; color:inherit; cursor:pointer;">
                            {{ pub.text }}
                        </a>
                    </div>
                    
                    <div class="post-tags">
                        {% for tag in pub.tags.all %}
                        <span class="tag">#{{ tag }}</span>
                        {% endfor %}
                    </div>
                    
                    <div class="post-stats">
                        {% if request.user.is_authenticated %}
                            <button type="button" class="comments-toggle-btn" data-slug="{{ pub.slug }}">
                                üí¨ {{ pub.comments.count }}
                            </button>
                        {% else %}
                            <span style="color:inherit; cursor:default;">
                                üí¨ {{ pub.comments.count }}
                            </span>
                        {% endif %}
                        
                        <span class="like-button" data-slug="{{ pub.slug }}" style="cursor:pointer;">
                            ‚ù§Ô∏è <span class="like-count">{{ pub.likes.count }}</span>
                        </span>
                    </div>
                </div>
                
                {% for comment in pub.comments.all|slice:":3" %} 
                    {% if not comment.parent %}
                    <div class="comment-section-wrapper">
                        <div class="comment-item">
                            <div class="comment-author">
                                <a href="{% url 'profile' comment.user.username %}" class="user-avatar comment-avatar">
                                    {{ comment.user.username|first|upper }}
                                </a>
                                {{ comment.user }}
                                <span class="post-handle">@{{ comment.user }}</span>
                            </div>
                            <div class="comment-text">{{ comment.text }}</div>
                        </div>
                    </div>
                    {% endif %} 
                {% endfor %}
            </div>
            {% empty %}
            <div style="padding: 20px; text-align: center; color: #5b7083;">
                Zatiaƒæ nie je k dispoz√≠cii ≈æiadny obsah pre nov√°ƒçikov.
            </div>
            {% endfor %}
            
            <!-- –ü–∞–≥—ñ–Ω–∞—Ü—ñ—è -->
            <div class="pagination">
                {% if page_explore > 0 %}
                <form method="get" style="flex: 1;">
                    <input type="hidden" name="page_explore" value="{{ page_explore|add:'-1' }}" />
                    <input type="hidden" name="active_feed" value="feed2" />
                    <button type="submit" class="post-button" style="width: 100%; margin-top: 0;">
                        dozadu
                    </button>
                </form>
                {% endif %}

                <form method="get" style="flex: 1;">
                    <input type="hidden" name="page_explore" value="{{ page_explore|add:'1' }}" />
                    <input type="hidden" name="active_feed" value="feed2" />
                    <button type="submit" class="post-button" style="width: 100%; margin-top: 0;">
                        dopredu
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞ –∫–æ–ª–æ–Ω–∫–∞ –∑ —Ç–µ–≥–∞–º–∏ -->
    <div class="sidebar-right">
        <div class="trends-block">
            <h3>Trendy tags</h3>
            {% for tag in tags %}
            <div class="trend-item">
                <div class="trend-name">{{ tag.name }}</div>
                <div class="trend-category">{{ tag.usage_count|humanize_k }} publik√°ci√≠</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –ø–æ—à—É–∫—É -->
    <div id="search-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-md mx-auto">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 class="text-lg font-bold">Hƒæada≈•</h3>
                    <button id="search-close" class="text-gray-500 hover:text-gray-700 text-2xl">
                        √ó
                    </button>
                </div>
                <div class="p-4">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Zadajte vyhƒæad√°vac√≠ dopyt..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    />
                </div>
                <div class="p-4 border-t text-sm text-gray-500">
                    Stlaƒçen√≠m kl√°vesu Enter spust√≠te vyhƒæad√°vanie
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –∫–æ–º–µ–Ω—Ç–∞—Ä—è (–æ–¥–Ω–µ –¥–ª—è –≤—Å—ñ—Ö –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π) -->
    <div id="comment-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-md mx-auto">
                <div class="flex items-center justify-between p-4 border-b">
                    <h3 id="comment-modal-title" class="text-lg font-bold">Prida≈• koment√°r</h3>
                    <button id="comment-modal-close" class="text-gray-500 hover:text-gray-700 text-2xl">
                        √ó
                    </button>
                </div>
                <div class="p-4">
                    <!-- –§–æ—Ä–º–∞ –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è -->
                    <form id="comment-form" method="POST">
                        {% csrf_token %}
                        <input type="hidden" id="comment-publication-slug" name="slug" />
                        <textarea
                            id="comment-text"
                            name="text"
                            placeholder="Nap√≠≈°te svoj koment√°r..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                            rows="4"
                            required
                        ></textarea>
                        <div class="mt-4 flex justify-end gap-2">
                            <button type="button" id="comment-cancel" class="px-4 py-2 text-gray-600 hover:text-gray-800">
                                Zru≈°i≈•
                            </button>
                            <button type="submit" class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">
                                Odosla≈•
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –ê–ö–¢–ò–í–ù–û–ì–û –§–Ü–î–£ ---
            const urlParams = new URLSearchParams(window.location.search);
            const activeFeedFromUrl = urlParams.get('active_feed');

            if (activeFeedFromUrl) {
                const targetTab = document.querySelector(`.feed-tab[data-feed="${activeFeedFromUrl}"]`);
                const targetContent = document.getElementById(activeFeedFromUrl);

                if (targetTab && targetContent) {
                    document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.feed-content').forEach(content => content.classList.remove('active'));
                    
                    targetTab.classList.add('active');
                    targetContent.classList.add('active');
                }
            }

            // --- –ü–ï–†–ï–ú–ò–ö–ê–ß –§–Ü–î–Ü–í ---
            document.querySelectorAll('.feed-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const feedId = tab.getAttribute('data-feed');
                    
                    document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    document.querySelectorAll('.feed-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(feedId).classList.add('active');
                });
            });

            // --- –õ–ê–ô–ö–ò ---
            document.querySelectorAll('.like-button').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const slug = btn.dataset.slug;
                    const response = await fetch(`/like/${slug}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });
                    const data = await response.json();
                    btn.querySelector('.like-count').textContent = data.likes;
                });
            });

            // --- –ü–û–®–£–ö ---
            const searchToggle = document.getElementById('search-toggle');
            const searchModal = document.getElementById('search-modal');
            const searchClose = document.getElementById('search-close');
            const searchInput = document.getElementById('search-input');

            if (searchToggle) {
                searchToggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    searchModal.classList.remove('hidden');
                    searchInput.focus();
                });
            }

            if (searchClose) {
                searchClose.addEventListener('click', () => {
                    searchModal.classList.add('hidden');
                    searchInput.value = '';
                });
            }

            if (searchModal) {
                searchModal.addEventListener('click', (e) => {
                    if (e.target === searchModal) {
                        searchModal.classList.add('hidden');
                        searchInput.value = '';
                    }
                });
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && searchModal && !searchModal.classList.contains('hidden')) {
                    searchModal.classList.add('hidden');
                    searchInput.value = '';
                }
            });

            if (searchInput) {
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const searchQuery = searchInput.value.trim();
                        if (searchQuery) {
                            const baseUrl = window.location.origin;
                            window.location.href = `${baseUrl}/search/${encodeURIComponent(searchQuery)}/`;
                        }
                    }
                });
            }

            // --- –ö–û–ú–ï–ù–¢–ê–†–Ü (–ù–û–í–ò–ô –ö–û–î) ---
            const commentModal = document.getElementById('comment-modal');
            const commentModalClose = document.getElementById('comment-modal-close');
            const commentCancel = document.getElementById('comment-cancel');
            const commentForm = document.getElementById('comment-form');
            const commentPublicationSlug = document.getElementById('comment-publication-slug');
            const commentText = document.getElementById('comment-text');

            // –í—ñ–¥–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏ –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
            document.querySelectorAll('.comments-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const slug = btn.dataset.slug;
                    
                    // –ó–∞–ø–∏—Å—É—î–º–æ slug –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó —É –ø—Ä–∏—Ö–æ–≤–∞–Ω–µ –ø–æ–ª–µ
                    commentPublicationSlug.value = slug;
                    
                    // –û—á–∏—â–∞—î–º–æ —Ç–µ–∫—Å—Ç –∫–æ–º–µ–Ω—Ç–∞—Ä—è
                    commentText.value = '';
                    
                    // –ü–æ–∫–∞–∑—É—î–º–æ –º–æ–¥–∞–ª–∫—É
                    commentModal.classList.remove('hidden');
                    commentText.focus();
                });
            });

            // –ó–∞–∫—Ä–∏—Ç—Ç—è –º–æ–¥–∞–ª–∫–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—è
            if (commentModalClose) {
                commentModalClose.addEventListener('click', () => {
                    commentModal.classList.add('hidden');
                    commentText.value = '';
                });
            }

            if (commentCancel) {
                commentCancel.addEventListener('click', () => {
                    commentModal.classList.add('hidden');
                    commentText.value = '';
                });
            }

            if (commentModal) {
                commentModal.addEventListener('click', (e) => {
                    if (e.target === commentModal) {
                        commentModal.classList.add('hidden');
                        commentText.value = '';
                    }
                });
            }

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && commentModal && !commentModal.classList.contains('hidden')) {
                    commentModal.classList.add('hidden');
                    commentText.value = '';
                }
            });

            // –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º–∏ –∫–æ–º–µ–Ω—Ç–∞—Ä—è (AJAX)
            if (commentForm) {
                commentForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const slug = commentPublicationSlug.value;
                    const text = commentText.value.trim();
                    
                    if (!text) {
                        alert('Pros√≠m, nap√≠≈°te koment√°r!');
                        return;
                    }
                    
                    try {
                        const response = await fetch(`/create_c/${slug}/`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": "{{ csrf_token }}"
                            },
                            body: JSON.stringify({ text: text })
                        });
                        
                        if (response.ok) {
                            // –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–æ—Ä—ñ–Ω–∫—É –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫–æ–º–µ–Ω—Ç–∞—Ä—è
                            window.location.reload();
                        } else {
                            alert('Chyba pri prid√°van√≠ koment√°ra.');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        alert('Chyba pri prid√°van√≠ koment√°ra.');
                    }
                });
            }
        });
    </script>
</body>
</html>