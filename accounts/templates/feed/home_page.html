{% extends "main.html" %}
{% block title %}Feed{% endblock %}

{% block extra_css %}
{% load static %}
<style>
/* Фіксуємо мінімальну висоту для контенту */
.main-content {
    min-height: calc(100vh - 200px); /* 200px для футера */
    display: flex;
    flex-direction: column;
}

.feed-content {
    flex: 1;
    min-height: 500px; /* Мінімальна висота для запобігання стрибкам */
}

.loading-spinner {
    display: none;
    text-align: center;
    padding: 20px;
    color: #5b7083;
}
.loading-spinner.active {
    display: block;
}

/* Плавна поява нового контенту */
.publication-wrapper {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Skeleton loader для кращого UX */
.loading-spinner.active::after {
    content: '';
    display: block;
    width: 100%;
    height: 100px;
    background: linear-gradient(
        90deg,
        #f0f0f0 25%,
        #e0e0e0 50%,
        #f0f0f0 75%
    );
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
    border-radius: 8px;
    margin-top: 10px;
}

@keyframes loading {
    0% {
        background-position: 200% 0;
    }
    100% {
        background-position: -200% 0;
    }
}

/* Адаптація для мобілки */
@media (max-width: 768px) {
    .main-content {
        min-height: calc(100vh - 150px);
    }
    
    .feed-content {
        min-height: 400px;
    }
}
</style>
{% endblock %}

{% block content %}
{% load static %}

<div class="main-content">
    <!-- Перемикач фідів -->
    <div class="feed-switcher">
        <div class="feed-tab active" data-feed="feed1">Hlavna stranka</div>
        {% if request.user.is_authenticated %}
        <div class="feed-tab" data-feed="feed2">Objavovanie</div>
        {% endif %}
    </div>

    <!-- Перший фід -->
    <div id="feed1" class="feed-content active">
        <div class="publications-container">
            {% include 'feed/modal_parts/publication_list.html' with publications=publication %}
        </div>
        
        <div class="loading-spinner">
            <p>Načítavanie...</p>
        </div>
        
        {% if not publication %}
        <div class="empty-feed" style="padding: 20px; text-align: center; color: #5b7083;">
            Zatiaľ žiadny obsah
        </div>
        {% endif %}
    </div>

    <!-- Другий фід -->
    <div id="feed2" class="feed-content">
        <div class="publications-container">
            {% include 'feed/modal_parts/publication_list.html' with publications=explore_publications %}
        </div>
        
        <div class="loading-spinner">
            <p>Načítavanie...</p>
        </div>
        
        {% if not explore_publications %}
        <div class="empty-feed" style="padding: 20px; text-align: center; color: #5b7083;">
            Zatiaľ nie je k dispozícii žiadny obsah pre nováčikov.
        </div>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/push_comments.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    // Стан пагінації для кожного фіду
    let feedState = {
        feed1: { page: 0, loading: false, hasMore: true },
        feed2: { page: 0, loading: false, hasMore: true }
    };
    
    let currentFeed = 'feed1';
    
    // --- ПЕРЕМИКАЧ ФІДІВ ---
    document.querySelectorAll('.feed-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const feedId = tab.getAttribute('data-feed');
            currentFeed = feedId;
            
            document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');

            document.querySelectorAll('.feed-content').forEach(content => content.classList.remove('active'));
            document.getElementById(feedId).classList.add('active');
        });
    });

    // --- INFINITE SCROLL ---
    const loadMorePosts = async (feedId) => {
        const state = feedState[feedId];
        
        if (state.loading || !state.hasMore) return;
        
        state.loading = true;
        const feedContent = document.getElementById(feedId);
        const spinner = feedContent.querySelector('.loading-spinner');
        spinner.classList.add('active');
        
        try {
            state.page += 1;
            const pageParam = feedId === 'feed1' ? 'page_feed' : 'page_explore';
            const url = `?${pageParam}=${state.page}&feed_type=${feedId}`;
            
            const response = await fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            const data = await response.json();
            
            if (data.html.trim()) {
                const container = feedContent.querySelector('.publications-container');
                container.insertAdjacentHTML('beforeend', data.html);
                
                // Реініціалізуємо лайки для нових постів
                initializeLikes();
                
                state.hasMore = data.has_more;
            } else {
                state.hasMore = false;
            }
        } catch (error) {
            console.error('Помилка завантаження:', error);
            state.page -= 1; // Повертаємо сторінку назад при помилці
        } finally {
            state.loading = false;
            spinner.classList.remove('active');
        }
    };

    // Відстежування прокрутки з урахуванням футера
    const handleScroll = () => {
        const feedContent = document.getElementById(currentFeed);
        if (!feedContent || !feedContent.classList.contains('active')) return;
        
        // Використовуємо getBoundingClientRect для точнішого визначення
        const container = feedContent.querySelector('.publications-container');
        if (!container) return;
        
        const containerRect = container.getBoundingClientRect();
        const triggerPoint = window.innerHeight - 400; // Завантажуємо за 400px
        
        // Перевіряємо чи дно контейнера досягло точки тригеру
        if (containerRect.bottom <= triggerPoint) {
            loadMorePosts(currentFeed);
        }
    };

    // Throttle для оптимізації
    let scrollTimeout;
    window.addEventListener('scroll', () => {
        if (scrollTimeout) clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(handleScroll, 100);
    });

    // --- ЛАЙКИ ---
    function initializeLikes() {
        document.querySelectorAll('.like-button').forEach(btn => {
            // Видаляємо старі обробники
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.addEventListener('click', async () => {
                const slug = newBtn.dataset.slug;
                try {
                    const response = await fetch(`/like/${slug}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });
                    const data = await response.json();
                    newBtn.querySelector('.like-count').textContent = data.likes;
                } catch (error) {
                    console.error('Помилка лайку:', error);
                }
            });
        });
    }
    
    initializeLikes();
});
</script>
{% endblock %}