<!DOCTYPE html>
<html lang="uk">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>FX</title>
		{% load static %}
		<link rel="stylesheet" href="{% static 'css/main.css' %}" />
		<script src="https://cdn.tailwindcss.com"></script>
	</head>
	<body>
		{% load number_filters %} {% include "nav_bar.html" %}

		<div class="main-content">
			<!-- 햣햣햪햦햨햟혢 혟혰햢혰 -->
			<div class="feed-switcher">
				<div class="feed-tab active" data-feed="feed1">Hlavna stranka</div>
				{%if request.user.is_authenticated%}
				<div class="feed-tab" data-feed="feed2">Nove pr칤spevky</div>
				{%endif%}
			</div>

			<!-- 햣혣햦햧 혟혰햢 -->
			<div id="feed1" class="feed-content active">
				<!--                
                <div class="new-post-form">
                    <form method="POST" action="{% url 'create_publication' %}">
                        {% csrf_token %}
                        <input type="text" name="title" placeholder="N치zov" class="post-textarea" style="font-weight: bold; padding: 5px 0; margin: 5px 0;"><br>
                        <textarea name="text" class="post-textarea" placeholder="Co sa deje?"></textarea><br>
                        <input type="text" name="tags" class="post-textarea" placeholder="Tagy (oddeli medzerou alebo cez ,)"><br>
                        <button type="submit" class="post-button">Publikovat</button>
                    </form>
                    <div style="clear: both;"></div>
                </div>
                -->

				{% for pub in publication %}
				<div class="publication-wrapper">
					<div>
						<div class="post-author">
							<a href="{% url 'profile' pub.user.username %}" class="user-avatar">
								{{ pub.user.username|first|upper }}
							</a>
							{{ pub.title }}
							<span class="post-handle">
								@{{ pub.user.username }}
							</span>
						</div>

						<div class="post-text">
							<a href="{% url 'pub' pub.slug %}" style="text-decoration:none; color:inherit; cursor:pointer;">
								{{ pub.text }}
							</a>
						</div>
						<div class="post-tags">
							{% for tag in pub.tags.all %}
							<span class="tag">#{{ tag }}</span>
							{% endfor %}
						</div>
						<div class="post-stats">
							{%if request.user.is_authenticated%}
							<a href="{% url 'create_comments' pub.slug %}" style="text-decoration:none; color:inherit; cursor:pointer;">
								游눫 {{ pub.comments.count }}
							</a>
							{%else%}
							<a style="text-decoration:none; color:inherit; cursor:pointer;">
								游눫 {{ pub.comments.count }}
							</a>
							{%endif%}
							<span class="like-button" data-slug="{{ pub.slug }}" style="cursor:pointer;"> 仇벒잺 <span class="like-count">{{ pub.likes.count }}</span> </span>
						</div>
					</div>

					{% for comment in pub.comments.all|slice:":3" %} {% if not comment.parent %}
					<div class="comment-section-wrapper">
						<div class="comment-item">
							<div class="comment-author">
								<a href="{% url 'profile' comment.user.username %}" class="user-avatar comment-avatar">
									{{ comment.user.username|first|upper }}
								</a>
								{{ comment.user }}
								<span class="post-handle">@{{ comment.user }}</span>
							</div>
							<div class="comment-text">{{ comment.text }}</div>
						</div>
					</div>
					{% endif %} {% endfor %}
				</div>
				{% empty %}
				<div style="padding: 20px; text-align: center; color: #5b7083;">
					Zatia 쬴adny obsah
				</div>
				{% endfor %}
				<div class="pagination" style="width: 100%; margin-top: 20px; display: flex; gap: 10px;">
					{% if page_feed > 0 %}
					<form method="get" style="flex: 1;">
						<input type="hidden" name="page_feed" value="{{ page_feed|add:"-1" }}">
						<button type="submit" class="post-button" style="width: 100%; margin-top: 0;">dozadu</button>
					</form>
					{% endif %}

					<form method="get" style="flex: 1;">
						<input type="hidden" name="page_feed" value="{{ page_feed|add:"1" }}">
						<button type="submit" class="post-button" style="width: 100%; margin-top: 0;">dopredu</button>
					</form>
				</div>
			</div>

			<!-- 햆혞햡햦햧 혟혰햢 -->
			<div id="feed2" class="feed-content">
				<!--
                <div class="new-post-form">
                    <form method="POST" action="{% url 'create_publication' %}">
                        {% csrf_token %}
                        <input type="text" name="title" placeholder="N치zov" class="post-textarea" style="font-weight: bold; padding: 5px 0; margin: 5px 0;"><br>
                        <textarea name="text" class="post-textarea" placeholder="Co sa deje?"></textarea><br>
                        <input type="text" name="tags" class="post-textarea" placeholder="Tagy (oddeli medzerou alebo cez ,)"><br>
                        <button type="submit" class="post-button">Publikovat</button>
                    </form>
                    <div style="clear: both;"></div>
                </div>
                -->
				{% for pub in explore_publications %}
				<div class="publication-wrapper">
					<div>
						<div class="post-author">
							<a href="{% url 'profile' pub.user.username %}" class="user-avatar">
								{{ pub.user.username|first|upper }}
							</a>
							{{ pub.title }}
							<span class="post-handle">@{{ pub.user.username }}</span>
						</div>
						<div class="post-text">
							<a href="{% url 'pub' pub.slug %}" style="text-decoration:none; color:inherit; cursor:pointer;">
								{{ pub.text }}
							</a>
						</div>
						<div class="post-tags">
							{% for tag in pub.tags.all %}
							<span class="tag">#{{ tag }}</span>
							{% endfor %}
						</div>
						<div class="post-stats">
							<a href="{% url 'create_comments' pub.slug %}" style="text-decoration:none; color:inherit; cursor:pointer;">
								游눫 {{ pub.comments.count }}
							</a>
							<span class="like-button" data-slug="{{ pub.slug }}" style="cursor:pointer;"> 仇벒잺 <span class="like-count">{{ pub.likes.count }}</span> </span>
						</div>
					</div>
					{% for comment in pub.comments.all|slice:":3" %} {% if not comment.parent %}
					<div class="comment-section-wrapper">
						<div class="comment-item">
							<div class="comment-author">
								<a href="{% url 'profile' comment.user.username %}" class="user-avatar comment-avatar">
									{{ comment.user.username|first|upper }}
								</a>
								{{ comment.user }}
								<span class="post-handle">@{{ comment.user }}</span>
							</div>
							<div class="comment-text">{{ comment.text }}</div>
						</div>
					</div>
					{% endif %} {% endfor %}
				</div>
				{% empty %}
				<div style="padding: 20px; text-align: center; color: #5b7083;">
					Zatia nie je k dispoz칤cii 쬴adny obsah pre nov치캜ikov.
				</div>
				{% endfor %}
				<div class="pagination" style="width: 100%; margin-top: 20px; display: flex; gap: 10px;">
					{% if page_explore > 0 %}
					<form method="get" style="flex: 1;">
						<input type="hidden" name="page_explore" value="{{ page_explore|add:"-1" }}">
						<button type="submit" class="post-button" style="width: 100%; margin-top: 0;">dozadu</button>
					</form>
					{% endif %}

					<form method="get" style="flex: 1;">
						<input type="hidden" name="page_explore" value="{{ page_explore|add:"1" }}">
						<button type="submit" class="post-button" style="width: 100%; margin-top: 0;">dopredu</button>
					</form>
				</div>
			</div>
		</div>

		<div class="sidebar-right">
			<div class="trends-block">
				<h3>Trendy tags</h3>
				{% for tag in tags %}
				<div class="trend-item">
					<div class="trend-name">{{ tag.name }}</div>
					<div class="trend-category">{{ tag.usage_count|humanize_k }} 혝쒬뒘혰</div>
				</div>
				{% endfor %}
			</div>
		</div>

		<!-- 햎쮏얧썛혧햫햣 쒬뒗쥃쫧 쮐걤햨혞 -->
		<div id="search-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
			<div class="flex items-center justify-center min-h-screen p-4">
				<div class="bg-white rounded-2xl w-full max-w-md mx-auto">
					<!-- 행햟햡쮏쮏쒫쮏 -->
					<div class="flex items-center justify-between p-4 border-b">
						<h3 class="text-lg font-bold">H쬬da콘</h3>
						<button id="search-close" class="text-gray-500 hover:text-gray-700 text-2xl">
							칑
						</button>
					</div>

					<!-- 쮏햣 쮐걤햨혞 -->
					<div class="p-4">
						<input
							type="text"
							id="search-input"
							placeholder="Zadajte vyh쬬d치vac칤 dopyt..."
							class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
						/>
					</div>

					<!-- 혰햢쒫썛 -->
					<div class="p-4 border-t text-sm text-gray-500">
						Stla캜en칤m kl치vesu Enter spust칤te vyh쬬d치vanie
					</div>
				</div>
			</div>
		</div>

		<script>
			    document.addEventListener("DOMContentLoaded", () => {
			        // 뤯쐄쮏쐃쥃 햣햣햪햦햨햟혢햟 혟혰햢혰
			        document.querySelectorAll('.feed-tab').forEach(tab => {
			            tab.addEventListener('click', () => {
			                document.querySelectorAll('.feed-tab').forEach(t => {
			                    t.classList.remove('active');
			                });
			                tab.classList.add('active');

			                document.querySelectorAll('.feed-content').forEach(content => {
			                    content.classList.remove('active');
			                });
			                const feedId = tab.getAttribute('data-feed');
			                document.getElementById(feedId).classList.add('active');
			            });
			        });

			        // 뤯쐄쮏쐃쥃 햩햟햧햨혰
			        document.querySelectorAll('.like-button').forEach(btn => {
			            btn.addEventListener('click', async () => {
			                const slug = btn.dataset.slug;
			                const response = await fetch(`/like/${slug}/`, {
			                    method: "POST",
			                    headers: {
			                        "X-CSRFToken": "{{ csrf_token }}",
			                        "X-Requested-With": "XMLHttpRequest"
			                    }
			                });
			                const data = await response.json();
			                btn.querySelector('.like-count').textContent = data.likes;
			            });
			        });

			        // 쮐걤햨쮏쒫 햪쮏얧썛혧햫햣 쒬뒗쥃쫧
			        const searchToggle = document.getElementById('search-toggle');
			        const searchModal = document.getElementById('search-modal');
			        const searchClose = document.getElementById('search-close');
			        const searchInput = document.getElementById('search-input');
			        const searchForm = document.getElementById('search-form');

			        // 뉌뒗얧쥄햦혝혝혪 쮐걤햨혞
			        if (searchToggle) {
			            searchToggle.addEventListener('click', (e) => {
			                e.preventDefault();
			                searchModal.classList.remove('hidden');
			                searchInput.focus();
			            });
			        }

			        // 행햟햨햦혝혝혪 쮐걤햨혞
			        if (searchClose) {
			            searchClose.addEventListener('click', () => {
			                searchModal.classList.add('hidden');
			                searchInput.value = '';
			            });
			        }

			        // 행햟햨햦혝혝혪  햨햩혰햨혞 햫햟 혟쮏
			        if (searchModal) {
			            searchModal.addEventListener('click', (e) => {
			                if (e.target === searchModal) {
			                    searchModal.classList.add('hidden');
			                    searchInput.value = '';
			                }
			            });
			        }

			        // 행햟햨햦혝혝혪  Escape
			        document.addEventListener('keydown', (e) => {
			            if (e.key === 'Escape' && searchModal && !searchModal.classList.contains('hidden')) {
			                searchModal.classList.add('hidden');
			                searchInput.value = '';
			            }
			        });

			        // 뉌뒗얧햟쒫쥃 혟쮐햪햦  Enter
			        if (searchInput) {
			    searchInput.addEventListener('keydown', (e) => {
			        if (e.key === 'Enter') {
			            e.preventDefault();
			            const searchQuery = searchInput.value.trim();
			            if (searchQuery) {
			                // 햣햣혠쮏얧쟳쨿 햫햟 혜혝쮐혰햫햨혞 쮐걤햨혞 향 햟햟햪햣혝쮏  URL
			                const baseUrl = window.location.origin; // 쮐햦햪혞혮햪 http://localhost:8000
			                window.location.href = `${baseUrl}/search/${encodeURIComponent(searchQuery)}/`;

			            }
			        }
			    });
			}
			    });
		</script>
	</body>
</html>
