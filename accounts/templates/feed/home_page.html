{% extends "main.html" %}
{% block title %}Feed{% endblock %}

{% block extra_css %}
{% load static %}

{% endblock %}

{% block content %}
{% load static %}

<div class="main-content">
    <!-- Перемикач фідів -->
    <div class="feed-switcher">
        <div class="feed-tab active" data-feed="feed1">Hlavna stranka</div>
        {% if request.user.is_authenticated %}
        <div class="feed-tab" data-feed="feed2">Nové</div>
        {% endif %}
    </div>

    <!-- Перший фід -->
    <div id="feed1" class="feed-content active">
        <div class="publications-container">
            {% include 'feed/modal_parts/publication_list.html' with publications=publication %}
        </div>
        
        <div class="loading-spinner">
            <p>Načítavanie...</p>
        </div>
        
        {% if not publication %}
        <div class="empty-feed" style="padding: 20px; text-align: center; color: #5b7083;">
            Zatiaľ žiadny obsah
        </div>
        {% endif %}
        
        <!-- Контейнер для кнопки завантаження -->
        <div class="load-more-btn-container">
            <button class="load-more-btn" data-feed="feed1">Načítať viac</button>
        </div>
        
        <!-- Лічильник постів
        <div class="posts-counter" data-feed="feed1">
            Zobrazené: <span class="posts-count">0</span> publikácií
        </div>
        -->
    </div>

    <!-- Другий фід -->
    <div id="feed2" class="feed-content">
        <div class="publications-container">
            {% include 'feed/modal_parts/publication_list.html' with publications=explore_publications %}
        </div>
        
        <div class="loading-spinner">
            <p>Načítavanie...</p>
        </div>
        
        {% if not explore_publications %}
        <div class="empty-feed" style="padding: 20px; text-align: center; color: #5b7083;">
            Zatiaľ nie je k dispozícii žiadny obsah pre nováčikov.
        </div>
        {% endif %}
        
        <!-- Контейнер для кнопки завантаження -->
        <div class="load-more-btn-container">
            <button class="load-more-btn" data-feed="feed2">Načítať viac</button>
        </div>
        
        <!-- Лічильник постів 
        <div class="posts-counter" data-feed="feed2">
            Zobrazené: <span class="posts-count">0</span> publikácií
        </div>
        -->
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/push_comments.js' %}"></script>
<script>
(function() {
    // Конфігурація
    const POSTS_PER_PAGE = 10; // Скільки постів завантажується за раз
    const SCROLL_THRESHOLD = 800; // Коли завантажувати автоматично (px від низу)
    
    // Стан для кожного фіду
    const feedState = {
        feed1: { 
            page: 1, 
            loading: false, 
            hasMore: true, 
            initialLoad: false,
            totalLoaded: 0
        },
        feed2: { 
            page: 1, 
            loading: false, 
            hasMore: true, 
            initialLoad: false,
            totalLoaded: 0
        }
    };
    
    let currentFeed = 'feed1';
    let isScrolling = false;
    
    // Оновлення лічильника постів
    function updatePostsCounter(feedId) {
        const feedContent = document.getElementById(feedId);
        if (!feedContent) return;
        
        const container = feedContent.querySelector('.publications-container');
        const posts = container.querySelectorAll('.publication-wrapper');
        const counter = feedContent.querySelector('.posts-count');
        const state = feedState[feedId];
        
        state.totalLoaded = posts.length;
        
        if (counter) {
            counter.textContent = state.totalLoaded;
        }
        
        // Оновлюємо кнопку
        updateLoadMoreButton(feedId);
    }
    
    // Оновлення стану кнопки
    function updateLoadMoreButton(feedId) {
        const feedContent = document.getElementById(feedId);
        if (!feedContent) return;
        
        const btn = feedContent.querySelector('.load-more-btn');
        const state = feedState[feedId];
        
        if (btn) {
            btn.disabled = state.loading || !state.hasMore;
            btn.classList.toggle('loading', state.loading);
            
            if (!state.hasMore && state.totalLoaded > 0) {
                btn.textContent = 'Všetky publikácie načítané';
            } else if (state.loading) {
                btn.textContent = 'Načítavanie...';
            } else {
                btn.textContent = 'Načítať viac';
            }
        }
    }
    
    // Ініціалізація вкладок
    function initTabs() {
        document.querySelectorAll('.feed-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const feedId = this.dataset.feed;
                
                // Оновлюємо активні вкладки
                document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                document.querySelectorAll('.feed-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                const activeContent = document.getElementById(feedId);
                activeContent.classList.add('active');
                
                currentFeed = feedId;
                
                // Оновлюємо лічильник
                updatePostsCounter(feedId);
                
                // Перевіряємо чи треба завантажити контент
                const container = activeContent.querySelector('.publications-container');
                const posts = container.querySelectorAll('.publication-wrapper');
                
                if (posts.length === 0 && !feedState[feedId].initialLoad) {
                    loadMorePosts(feedId);
                }
            });
        });
    }
    
    // Завантаження постів
    async function loadMorePosts(feedId, isManual = false) {
        const state = feedState[feedId];
        
        if (state.loading || !state.hasMore) return;
        
        state.loading = true;
        updateLoadMoreButton(feedId);
        
        const feedContent = document.getElementById(feedId);
        const spinner = feedContent.querySelector('.loading-spinner');
        if (spinner) spinner.classList.add('active');
        
        try {
            const pageParam = feedId === 'feed1' ? 'page_feed' : 'page_explore';
            const url = `?${pageParam}=${state.page}&feed_type=${feedId}`;
            
            const response = await fetch(url, {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            if (!response.ok) throw new Error('Помилка мережі');
            
            const data = await response.json();
            
            if (data.html && data.html.trim()) {
                const container = feedContent.querySelector('.publications-container');
                
                // При першому завантаженні прибираємо empty state
                if (state.page === 1) {
                    const emptyState = container.querySelector('.empty-feed');
                    if (emptyState) emptyState.style.display = 'none';
                }
                
                container.insertAdjacentHTML('beforeend', data.html);
                initializeLikes();
                
                // Оновлюємо стан
                state.hasMore = data.has_more !== false;
                if (data.has_more) {
                    state.page++;
                }
                
                state.initialLoad = true;
                
                // Оновлюємо лічильник
                updatePostsCounter(feedId);
                
                // Якщо завантажили мало постів, автоматично завантажуємо ще
                if (!isManual && state.totalLoaded < POSTS_PER_PAGE * 2 && state.hasMore) {
                    setTimeout(() => loadMorePosts(feedId), 300);
                }
                
            } else {
                state.hasMore = false;
                
                // Показуємо empty state якщо нічого не завантажилось
                if (state.page === 1) {
                    const container = feedContent.querySelector('.publications-container');
                    const emptyState = container.querySelector('.empty-feed');
                    if (!emptyState) {
                        container.innerHTML = '<div class="empty-feed" style="padding: 40px; text-align: center; color: #5b7083;">Žiadny obsah</div>';
                    }
                }
                
                updatePostsCounter(feedId);
            }
        } catch (error) {
            console.error('Помилка завантаження:', error);
            // Повертаємо сторінку назад при помилці
            state.page = Math.max(1, state.page - 1);
        } finally {
            state.loading = false;
            if (spinner) spinner.classList.remove('active');
            updateLoadMoreButton(feedId);
        }
    }
    
    // Перевірка скролу
    function checkScroll() {
        if (feedState[currentFeed].loading || !feedState[currentFeed].hasMore) return;
        
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const docHeight = document.documentElement.scrollHeight;
        
        // Завантажуємо коли залишилось SCROLL_THRESHOLD px до кінця
        if (scrollTop + windowHeight >= docHeight - SCROLL_THRESHOLD) {
            loadMorePosts(currentFeed);
        }
    }
    
    // Обробник скролу з throttle
    function handleScroll() {
        if (!isScrolling) {
            isScrolling = true;
            checkScroll();
            
            setTimeout(() => {
                isScrolling = false;
            }, 200);
        }
    }
    
    // Ініціалізація лайків
    function initializeLikes() {
        document.querySelectorAll('.like-button').forEach(btn => {
            if (btn.dataset.listener) return;
            
            btn.dataset.listener = 'true';
            
            btn.addEventListener('click', async function(e) {
                e.preventDefault();
                const slug = this.dataset.slug;
                
                try {
                    const response = await fetch(`/like/${slug}/`, {
                        method: "POST",
                        headers: {
                            "X-CSRFToken": "{{ csrf_token }}",
                            "Content-Type": "application/json",
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const countSpan = this.querySelector('.like-count');
                        if (countSpan) {
                            countSpan.textContent = data.likes;
                        }
                    }
                } catch (error) {
                    console.error('Помилка лайку:', error);
                }
            });
        });
    }
    
    // Ініціалізація кнопок завантаження
    function initLoadMoreButtons() {
        document.querySelectorAll('.load-more-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const feedId = this.dataset.feed;
                loadMorePosts(feedId, true);
            });
        });
    }
    
    // Ініціалізація сторінки
    function init() {
        initTabs();
        initializeLikes();
        initLoadMoreButtons();
        
        // Додаємо обробник скролу
        window.addEventListener('scroll', handleScroll);
        
        // Завантажуємо початковий контент для кожного фіду
        setTimeout(() => {
            // Для активного фіду
            const activeFeedContent = document.getElementById(currentFeed);
            const activeContainer = activeFeedContent.querySelector('.publications-container');
            const activePosts = activeContainer.querySelectorAll('.publication-wrapper');
            
            if (activePosts.length === 0 && !feedState[currentFeed].initialLoad) {
                loadMorePosts(currentFeed);
            } else {
                updatePostsCounter(currentFeed);
            }
            
            // Для неактивних фідів (попередньо завантажимо один раз)
            ['feed1', 'feed2'].forEach(feedId => {
                if (feedId !== currentFeed) {
                    const feedContent = document.getElementById(feedId);
                    if (feedContent) {
                        const container = feedContent.querySelector('.publications-container');
                        const posts = container.querySelectorAll('.publication-wrapper');
                        
                        if (posts.length === 0 && !feedState[feedId].initialLoad) {
                            // Можна попередньо завантажити одну сторінку
                            setTimeout(() => loadMorePosts(feedId), 500);
                        } else {
                            updatePostsCounter(feedId);
                        }
                    }
                }
            });
        }, 100);
    }
    
    // Запускаємо
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
})();
</script>
{% endblock %}
