{% extends "main.html" %}

{% block extra_css %}
{% load static %}
{% endblock %}

{% block content %}



<div class="main-content">
    <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Ñ—ñ–¥—ñ–≤ -->
    <div class="feed-switcher">
        <div class="feed-tab active" data-feed="feed1">Result</div>
    </div>

    <!-- –ü–µ—Ä—à–∏–π —Ñ—ñ–¥ -->
    <div id="feed1" class="feed-content active">
        {% for pub in posts %}
        <div class="publication-wrapper">
            <div>
                <div class="post-author">
                    <a href="{% url 'profile' pub.user.username %}" class="user-avatar">
                        {{ pub.user.username|first|upper }}
                    </a>
                    {{ pub.title }}
                    <span class="post-handle">
                        @{{ pub.user.username }}
                    </span>
                </div>

                <div class="post-text">
                    <a href="{% url 'pub' pub.slug %}" style="text-decoration:none; color:inherit; cursor:pointer;">
                        {{ pub.text }}
                    </a>
                </div>
                
                <div class="post-tags">
                    {% for tag in pub.tags.all %}
                    <span class="tag">#{{ tag }}</span>
                    {% endfor %}
                </div>
                
                <div class="post-stats">
                    <button type="button" class="comments-toggle-btn-origin" data-slug="{{ pub.slug }}">
                        üí¨ {{ pub.comments.count }}
                    </button>
                    <span class="like-button" data-slug="{{ pub.slug }}" style="cursor:pointer;">
                        ‚ù§Ô∏è <span class="like-count">{{ pub.likes.count }}</span>
                    </span>
                </div>
            </div>

            <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
            {% for comment in pub.comments.all|slice:":3" %} 
                {% if not comment.parent %}
                <div class="comment-section-wrapper">
                    <div class="comment-item">
                        <div class="comment-author">
                            <a href="{% url 'profile' comment.user.username %}" class="user-avatar comment-avatar">
                                {{ comment.user.username|first|upper }}
                            </a>
                            {{ comment.user }}
                            <span class="post-handle">@{{ comment.user }}</span>
                        </div>
                        <div class="comment-text">{{ comment.text }}</div>
                    </div>
                </div>
                {% endif %} 
            {% endfor %}
        </div>
        {% empty %}
        <div style="padding: 20px; text-align: center; color: #5b7083;">
            –ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –∫–æ–Ω—Ç–µ–Ω—Ç—É
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/push_comments.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // –û–±—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ —Ñ—ñ–¥—ñ–≤ (—è–∫—â–æ —ó—Ö –±—ñ–ª—å—à–µ –æ–¥–Ω–æ–≥–æ)
        document.querySelectorAll('.feed-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                // –í–∏–¥–∞–ª–∏—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–ª–∞—Å —É –≤—Å—ñ—Ö –≤–∫–ª–∞–¥–æ–∫
                document.querySelectorAll('.feed-tab').forEach(t => {
                    t.classList.remove('active');
                });
                
                // –î–æ–¥–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π –∫–ª–∞—Å –¥–æ –ø–æ—Ç–æ—á–Ω–æ—ó –≤–∫–ª–∞–¥–∫–∏
                tab.classList.add('active');

                // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ —Ñ—ñ–¥–∏
                document.querySelectorAll('.feed-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // –ü–æ–∫–∞–∑–∞—Ç–∏ –∞–∫—Ç–∏–≤–Ω–∏–π —Ñ—ñ–¥
                const feedId = tab.getAttribute('data-feed');
                document.getElementById(feedId).classList.add('active');
            });
        });

        // –û–±—Ä–æ–±–∫–∞ –ª–∞–π–∫—ñ–≤
        document.querySelectorAll('.like-button').forEach(btn => {
            btn.addEventListener('click', async () => {
                const slug = btn.dataset.slug;
                const response = await fetch(`/like/${slug}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });
                const data = await response.json();
                btn.querySelector('.like-count').textContent = data.likes;
            });
        });
    });
</script>
{% endblock %}
