{% extends "main.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/pub.css' %}" />
{% endblock %}

{% block content %}



<div class="main-content">
    <!-- –ü–µ—Ä–µ–º–∏–∫–∞—á —Ñ—ñ–¥—ñ–≤ -->
    <div class="feed-switcher">
        <div class="feed-tab active" data-feed="feed1">Lavka</div>
    </div>

    <!-- –ü–µ—Ä—à–∏–π —Ñ—ñ–¥ -->
    <div id="feed1" class="feed-content active">
        <main class="max-w-4xl mx-auto px-4 py-8">
            <div class="publication-wrapper">
                <div class="post-content">
                    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó -->
                    <div class="post-header">
                        <div class="post-author-info">
                            <div class="author-avatar">
                                {{ pub.user.username|first|upper }}
                            </div>
                            <div class="author-details">
                                <div class="post-author">{{ pub.title }} <span class="post-handle">@{{ pub.user.username }}</span></div>
                                <div class="post-time">{{ pub.created_at|timesince }} pred</div>
                            </div>
                        </div>
                        <div class="post-actions">
                            <button class="action-btn more-btn">‚ãØ</button>
                        </div>
                    </div>

                    <!-- –¢–µ–∫—Å—Ç –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó -->
                    <div class="post-text">{{ pub.text }}</div>

                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
                    <div class="post-stats">
                        {% if request.user.is_authenticated %}
                        <a class="stat-link comment-link comments-toggle-btn-origin" data-slug="{{ pub.slug }}">
                            <span class="stat-icon">üí¨</span>
                            <span class="stat-count">{{ pub.comments.count }}</span>
                        </a>
                        {% else %}
                        <a class="stat-link comment-link">
                            <span class="stat-icon">üí¨</span>
                            <span class="stat-count">{{ pub.comments.count }}</span>
                        </a>
                        {% endif %}

                        <span class="like-button stat-link" data-slug="{{ pub.slug }}">
                            <span class="stat-icon">‚ù§Ô∏è</span>
                            <span class="like-count stat-count">{{ pub.likes.count }}</span>
                        </span>

                        <button class="stat-link share-btn">
                            <span class="stat-icon">‚ÜóÔ∏è</span>
                            <span class="stat-count">Zdieƒæa≈•</span>
                        </button>

                        <div class="stat-link">
                            <a href="{% url 'home_page' %}" class="inline-block bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition">
                                ‚Üê Sp√§≈• do hlavnej stranke
                            </a>
                        </div>
                    </div>
                </div>

                <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä—ñ -->
                {% if pub.comments.all %}
                <div class="comments-container">
                    <div class="comments-header">
                        <h4>Komentare ({{ pub.comments.count }})</h4>
                    </div>

                    {% for comment in pub.comments.all %}
                        {% if not comment.parent %}
                        <div class="comment-thread">
                            <div class="comment-section-wrapper">
                                <div class="comment-header">
                                    <div class="comment-author-avatar">
                                        {{ comment.user.username|first|upper }}
                                    </div>
                                    <div class="comment-author-info">
                                        <span class="comment-author">{{ comment.user.username }}</span>
                                        <span class="comment-time">{{ comment.created_at|timesince }} pred</span>
                                    </div>
                                </div>
                                <div class="comment-text">{{ comment.text }}</div>
                                <div class="comment-actions">
                                    {% if request.user.is_authenticated %}
                                    <a class="stat-link comment-link comments-toggle-btn-origin reply-btn"
                                       data-slug="{{ pub.slug }}"
                                       data-parent="{{ comment.id }}">
                                        Odpoveƒè
                                    </a>
                                    {% else %}
                                    <a class="reply-btn">Odpoveƒè</a>
                                    {% endif %}
                                    <button class="comment-like-btn" data-comment-id="{{comment}}">
                                        ‚ô° <span class="comment-like-count">{{ comment.likes.count }}</span>
                                    </button>
                                </div>
                            </div>

                            {% for reply in comment.replies.all %}
                                {% include "post_users/_replies.html" with reply=reply %}
                            {% endfor %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </main>
    </div>
</div>


{% endblock %}

{% block extra_js %}
<script src="{% static 'js/push_comments.js' %}"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // –û–±—Ä–æ–±–∫–∞ –ª–∞–π–∫—ñ–≤ –¥–ª—è –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π
        document.querySelectorAll('.like-button').forEach(btn => {
            btn.addEventListener('click', async () => {
                const slug = btn.dataset.slug;
                const icon = btn.querySelector('.stat-icon');

                // –ê–Ω—ñ–º–∞—Ü—ñ—è
                icon.classList.add('liked');
                setTimeout(() => icon.classList.remove('liked'), 400);

                const response = await fetch(`/like/${slug}/`, {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });
                const data = await response.json();
                btn.querySelector('.like-count').textContent = data.likes;
            });
        });

        // –û–±—Ä–æ–±–∫–∞ –ª–∞–π–∫—ñ–≤ –¥–ª—è –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
        document.querySelectorAll('.comment-like-btn, .reply-like-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const commentId = btn.dataset.commentId;
                const icon = btn.querySelector('span:first-child');

                // –ê–Ω—ñ–º–∞—Ü—ñ—è
                icon.classList.add('liked');
                setTimeout(() => icon.classList.remove('liked'), 400);

                console.log('Like comment:', commentId);
                // –¢—É—Ç –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ AJAX –∑–∞–ø–∏—Ç –¥–ª—è –ª–∞–π–∫—ñ–≤ –∫–æ–º–µ–Ω—Ç–∞—Ä—ñ–≤
                // const response = await fetch(`/comment-like/${commentId}/`, {...});
            });
        });
    });
</script>
{% endblock %}
